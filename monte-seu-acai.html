<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#f5f3ff" />
  <title>LP Grill ‚Äî Monte seu A√ßa√≠</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="app">

  <header class="cover">
    <div class="cover-bg" aria-hidden="true"></div>

    <div class="topbar">
      <div class="brand">
        <a class="backlink" href="index.html" aria-label="Voltar ao menu">‚Üê</a>

        <div class="brand-txt">
          <h1>Monte seu A√ßa√≠</h1>
          <p>Escolha 1 tamanho + adicionais</p>
        </div>
      </div>

      <button class="cart-btn" id="openCart" aria-label="Abrir carrinho">
        <span class="cart-ico">üõí</span>
        <span class="cart-badge" id="cartCount">0</span>
      </button>
    </div>

    <div class="cover-info" id="infoBar"></div>
  </header>

  <main class="container">
    <section class="panel">
      <div class="panel-head">
        <h2>1) Tamanho (obrigat√≥rio)</h2>
        <p class="muted">Selecione 1 op√ß√£o para liberar ‚ÄúAdicionar ao carrinho‚Äù.</p>
      </div>
      <div class="builder-grid" id="acaiSizes"></div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>2) Acr√©scimos</h2>
        <p class="muted">Voc√™ pode escolher v√°rios.</p>
      </div>
      <div class="builder-grid" id="acaiExtras"></div>
    </section>

    <section class="panel">
      <div class="builder-footer">
        <div>
          <div class="muted">Total do item</div>
          <div class="builder-total" id="acaiTotal">R$ 0,00</div>
        </div>

        <button class="btn primary" id="addAcaiToCart" disabled>
          Adicionar ao carrinho
        </button>
      </div>

      <div style="margin-top:10px">
        <a class="btn light" href="finalizar.html" style="width:100%">Ir para Finalizar</a>
      </div>
    </section>
  </main>

  <a class="wa-float" id="waFloat" href="#" aria-label="WhatsApp">
    <img src="img/whatsapp.png" alt="WhatsApp" onerror="this.remove(); this.parentElement.textContent='WhatsApp';">
  </a>

  <div class="sticky-cta" id="stickyCTA" hidden>
    <button class="cta" id="ctaOpenCart" type="button">
      <span>Ver carrinho</span>
      <strong id="ctaTotal">R$ 0,00</strong>
    </button>
    <a class="cta primary" href="finalizar.html">Finalizar</a>
  </div>

  <!-- Carrinho (mesmo do index) -->
  <aside class="drawer" id="cartDrawer" aria-hidden="true">
    <div class="drawer-backdrop" id="closeCartBackdrop"></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Carrinho">
      <div class="drawer-head">
        <div>
          <h3>Seu carrinho</h3>
          <p class="muted">Itens + taxa (se entrega)</p>
        </div>
        <button class="icon-btn" id="closeCart" aria-label="Fechar">‚úï</button>
      </div>

      <div class="drawer-body">
        <div class="delivery-toggle">
          <button class="dt-btn" id="modeEntrega" type="button">üöö Entrega</button>
          <button class="dt-btn" id="modeRetirar" type="button">üè¨ Retirar</button>
        </div>

        <div id="cartItems"></div>
      </div>

      <div class="drawer-foot">
        <div class="totals">
          <div class="row"><span>Subtotal</span><strong id="subTotal">R$ 0,00</strong></div>
          <div class="row"><span>Taxa</span><strong id="deliveryFee">R$ 0,00</strong></div>
          <div class="row total"><span>Total</span><strong id="grandTotal">R$ 0,00</strong></div>
          <div class="mini muted">‚è±Ô∏è Tempo m√©dio: <span id="etaText">30‚Äì60 min</span></div>
        </div>

        <div class="drawer-actions">
          <button class="btn light" id="clearCart" type="button">Limpar</button>
          <a class="btn primary" href="finalizar.html">Finalizar</a>
        </div>
      </div>
    </div>
  </aside>

  <!-- scripts do projeto -->
  <script src="js/data.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/app.js"></script>

  <!-- builder (blindado) -->
  <script>
  (function(){
    "use strict";

    const $ = (s)=>document.querySelector(s);
    const money = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

    function getBuilderData(){
      // 1) padr√£o do seu projeto
      const b = window.MENU && window.MENU.builder ? window.MENU.builder : null;
      if(b && Array.isArray(b.sizes) && Array.isArray(b.addons)){
        return { sizes: b.sizes, extras: b.addons };
      }

      // 2) fallback compat√≠vel
      return {
        sizes: [
          { id:"300",  name:"300ml",  price:12.00 },
          { id:"500",  name:"500ml",  price:18.00 },
          { id:"700",  name:"700ml",  price:24.00 },
          { id:"1000", name:"1 Litro", price:32.00 }
        ],
        extras: [
          { id:"leite_po", name:"Leite em p√≥", price:2.50 },
          { id:"pacoca", name:"Pa√ßoca", price:2.50 },
          { id:"granola", name:"Granola", price:2.50 },
          { id:"castanha", name:"Castanha", price:3.50 },
          { id:"chocoball", name:"Chocoball", price:3.00 },
          { id:"ovomaltine", name:"Ovomaltine", price:4.00 },
          { id:"banana", name:"Banana", price:2.50 },
          { id:"morango", name:"Morango", price:4.00 },
          { id:"kiwi", name:"Kiwi", price:4.50 },
          { id:"nutella", name:"Nutella", price:5.00 },
          { id:"doce_leite", name:"Doce de leite", price:3.50 },
          { id:"mel", name:"Mel", price:3.00 }
        ]
      };
    }

    function makeChoiceCard({title, sub, price, active, onClick}) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "choice" + (active ? " active" : "");
      btn.innerHTML = `
        <div class="choice-left">
          <div class="choice-title">${title}</div>
          <div class="choice-sub muted">${sub || ""}</div>
        </div>
        <div class="choice-price">${money(price)}</div>
      `;
      btn.addEventListener("click", onClick);
      return btn;
    }

    function openCartFallback(){
      // se app.js n√£o expor openCart, tenta abrir simulando clique
      const btn = $("#openCart");
      if(btn) btn.click();
    }

    function boot(){
      const sizesEl  = $("#acaiSizes");
      const extrasEl = $("#acaiExtras");
      const totalEl  = $("#acaiTotal");
      const btnAdd   = $("#addAcaiToCart");

      if(!sizesEl || !extrasEl || !totalEl || !btnAdd) return;

      const DATA = getBuilderData();
      let selectedSize = null;
      const selectedExtras = new Set();

      function calcTotal(){
        let t = 0;
        if(selectedSize) t += Number(selectedSize.price||0);
        for(const id of selectedExtras){
          const it = DATA.extras.find(e=>e.id===id);
          if(it) t += Number(it.price||0);
        }
        return t;
      }

      function update(){
        totalEl.textContent = money(calcTotal());
        btnAdd.disabled = !selectedSize;
      }

      function render(){
        sizesEl.innerHTML = "";
        extrasEl.innerHTML = "";

        DATA.sizes.forEach(s=>{
          sizesEl.appendChild(makeChoiceCard({
            title: s.name,
            sub: "Base do a√ßa√≠",
            price: s.price,
            active: selectedSize && selectedSize.id === s.id,
            onClick: ()=>{
              selectedSize = s;
              render();
            }
          }));
        });

        DATA.extras.forEach(x=>{
          const on = selectedExtras.has(x.id);
          extrasEl.appendChild(makeChoiceCard({
            title: x.name,
            sub: on ? "Selecionado" : "Toque para adicionar",
            price: x.price,
            active: on,
            onClick: ()=>{
              if(on) selectedExtras.delete(x.id);
              else selectedExtras.add(x.id);
              render();
            }
          }));
        });

        update();
      }

      btnAdd.addEventListener("click", ()=>{
        if(!selectedSize) return;

        const extrasArr = Array.from(selectedExtras)
          .map(id => DATA.extras.find(e=>e.id===id))
          .filter(Boolean);

        const extrasTxt = extrasArr.length
          ? extrasArr.map(e=>e.name).join(", ")
          : "sem adicionais";

        const item = {
          key: `CUSTOM:${selectedSize.id}:${extrasArr.map(e=>e.id).sort().join("+") || "0"}`,
          name: `Monte seu A√ßa√≠ ‚Äî ${selectedSize.name}`,
          desc: `Adicionais: ${extrasTxt}`,
          price: calcTotal(),
          qty: 1
        };

        // usa carrinho real do projeto
        if(typeof window.addToCart === "function"){
          window.addToCart(item);
        }else{
          // fallback m√≠nimo
          try{
            const k = "acai_cart_v2";
            const cart = JSON.parse(localStorage.getItem(k) || "[]");
            cart.push(item);
            localStorage.setItem(k, JSON.stringify(cart));
          }catch(e){}
        }

        // atualiza UI do projeto se existir
        if(typeof window.renderCartDrawer === "function") window.renderCartDrawer();
        if(typeof window.renderCartEverywhere === "function") window.renderCartEverywhere();

        // abre carrinho
        if(typeof window.openCart === "function") window.openCart();
        else openCartFallback();
      });

      render();
    }

    // blindagem: nunca travar a p√°gina por erro
    try{
      if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
      else boot();
    }catch(err){
      console.error("Builder Monte A√ßa√≠:", err);
    }
  })();
  </script>

</body>
</html>
