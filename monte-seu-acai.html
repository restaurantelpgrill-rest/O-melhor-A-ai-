<script>
(() => {
  const money = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const $ = (s)=> document.querySelector(s);

  function getBuilderData(){
    // Prioridade 1: padrão do seu projeto (MENU.builder)
    const b = window.MENU && window.MENU.builder ? window.MENU.builder : null;
    if(b && Array.isArray(b.sizes) && Array.isArray(b.addons)){
      return { sizes: b.sizes, extras: b.addons };
    }

    // Prioridade 2: se você tiver outro formato (DATA.monteAcai)
    const d = window.DATA && window.DATA.monteAcai ? window.DATA.monteAcai : null;
    if(d && Array.isArray(d.sizes) && Array.isArray(d.extras)){
      return { sizes: d.sizes, extras: d.extras };
    }

    // Fallback (garante que nunca fica vazio)
    return {
      sizes: [
        { id:"300",  name:"300ml",  price:12.00 },
        { id:"500",  name:"500ml",  price:18.00 },
        { id:"700",  name:"700ml",  price:24.00 },
        { id:"1000", name:"1 Litro", price:32.00 }
      ],
      extras: [
        { id:"leite_po", name:"Leite em pó", price:2.50 },
        { id:"pacoca", name:"Paçoca", price:2.50 },
        { id:"granola", name:"Granola", price:2.50 },
        { id:"castanha", name:"Castanha", price:3.50 },
        { id:"chocoball", name:"Chocoball", price:3.00 },
        { id:"ovomaltine", name:"Ovomaltine", price:4.00 },
        { id:"banana", name:"Banana", price:2.50 },
        { id:"morango", name:"Morango", price:4.00 },
        { id:"kiwi", name:"Kiwi", price:4.50 },
        { id:"nutella", name:"Nutella", price:5.00 },
        { id:"doce_leite", name:"Doce de leite", price:3.50 },
        { id:"mel", name:"Mel", price:3.00 }
      ]
    };
  }

  function makeChoiceCard({title, sub, price, active, onClick}) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choice" + (active ? " active" : "");
    btn.innerHTML = `
      <div class="choice-left">
        <div class="choice-title">${title}</div>
        <div class="choice-sub muted">${sub || ""}</div>
      </div>
      <div class="choice-price">${money(price)}</div>
    `;
    btn.addEventListener("click", onClick);
    return btn;
  }

  function boot(){
    const sizesEl  = $("#acaiSizes");
    const extrasEl = $("#acaiExtras");
    const totalEl  = $("#acaiTotal");
    const btnAdd   = $("#addAcaiToCart");

    // Se não achou elementos, não tenta rodar (evita quebrar)
    if(!sizesEl || !extrasEl || !totalEl || !btnAdd) return;

    const DATA = getBuilderData();

    let selectedSize = null;
    const selectedExtras = new Set();

    function calcTotal(){
      let t = 0;
      if(selectedSize) t += Number(selectedSize.price||0);
      for(const id of selectedExtras){
        const it = DATA.extras.find(e=>e.id===id);
        if(it) t += Number(it.price||0);
      }
      return t;
    }

    function update(){
      totalEl.textContent = money(calcTotal());
      btnAdd.disabled = !selectedSize;
    }

    function render(){
      sizesEl.innerHTML = "";
      extrasEl.innerHTML = "";

      DATA.sizes.forEach(s=>{
        sizesEl.appendChild(makeChoiceCard({
          title: s.name,
          sub: "Base do açaí",
          price: s.price,
          active: selectedSize?.id === s.id,
          onClick: ()=>{
            selectedSize = s;
            render();
          }
        }));
      });

      DATA.extras.forEach(x=>{
        const on = selectedExtras.has(x.id);
        extrasEl.appendChild(makeChoiceCard({
          title: x.name,
          sub: on ? "Selecionado" : "Toque para adicionar",
          price: x.price,
          active: on,
          onClick: ()=>{
            if(on) selectedExtras.delete(x.id);
            else selectedExtras.add(x.id);
            render();
          }
        }));
      });

      update();
    }

    btnAdd.addEventListener("click", ()=>{
      if(!selectedSize) return;

      const extrasArr = Array.from(selectedExtras)
        .map(id => DATA.extras.find(e=>e.id===id))
        .filter(Boolean);

      const extrasTxt = extrasArr.length
        ? extrasArr.map(e=>e.name).join(", ")
        : "sem adicionais";

      const item = {
        key: `CUSTOM:${selectedSize.id}:${extrasArr.map(e=>e.id).sort().join("+") || "0"}`,
        name: `Monte seu Açaí — ${selectedSize.name}`,
        desc: `Adicionais: ${extrasTxt}`,
        price: calcTotal(),
        qty: 1
      };

      // ✅ Usa o carrinho REAL do seu projeto (cart.js)
      if(typeof window.addToCart === "function"){
        window.addToCart(item);
      }else{
        // fallback se alguém apagar cart.js
        try{
          const k = "acai_cart_v2";
          const cart = JSON.parse(localStorage.getItem(k) || "[]");
          cart.push(item);
          localStorage.setItem(k, JSON.stringify(cart));
        }catch(e){}
      }

      // Atualiza UI global do seu app, se existir
      if(typeof window.renderCartDrawer === "function") window.renderCartDrawer();
      if(typeof window.renderCartEverywhere === "function") window.renderCartEverywhere();

      // Abre carrinho (se existir openCart no seu app)
      if(typeof window.openCart === "function") window.openCart();
    });

    render();
  }

  // garante que roda mesmo se algum JS anterior atrasar
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();
</script>
